pipeline {
    agent any

    environment {
        AWS_REGION = "us-east-1"
        ACCOUNT_ID = "070622743298"
        FRONTEND_REPO = "mern-frontend"
        BACKEND_REPO = "mern-backend"
        FRONTEND_DOCKERFILE = "MERN-Stack-Ecommerce-App-master/Dockerfile"
        BACKEND_DOCKERFILE = "MERN-Stack-Ecommerce-App-master/backend/Dockerfile"
        EC2_USER = "ubuntu"
        EC2_HOST = "13.222.179.163"
        SSH_CREDENTIAL_ID = "jenkins-ecr-user"
        FRONTEND_PORT = "80"
        BACKEND_PORT = "3000"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Murugan6892/mern-ecommerce-test.git'
            }
        }

        stage('Build Frontend Docker Image') {
            steps {
                sh """
                docker build -t $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest -f $FRONTEND_DOCKERFILE .
                """
            }
        }

        stage('Build Backend Docker Image') {
            steps {
                sh """
                docker build -t $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:latest -f $BACKEND_DOCKERFILE .
                """
            }
        }

        stage('Login to AWS ECR') {
            steps {
                withAWS(credentials: 'aws-ecr', region: "$AWS_REGION") {
                    sh "aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
                }
            }
        }

        stage('Push Images to ECR') {
            steps {
                sh """
                docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest
                docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:latest
                """
            }
        }

        stage('Deploy on EC2 Slave') {
            steps {
                sshagent(credentials: ["$SSH_CREDENTIAL_ID"]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST '
                        echo "Logging in to AWS ECR..."
                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

                        echo "Pulling latest frontend and backend images..."
                        docker pull $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest
                        docker pull $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:latest

                        echo "Stopping old containers if running..."
                        docker rm -f frontend || true
                        docker rm -f backend || true

                        echo "Running new frontend container..."
                        docker run -d --name frontend -p $FRONTEND_PORT:80 $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$FRONTEND_REPO:latest

                        echo "Running new backend container..."
                        docker run -d --name backend -p $BACKEND_PORT:3000 $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$BACKEND_REPO:latest
                    '
                    """
                }
            }
        }
    }
}
