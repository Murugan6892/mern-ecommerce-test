pipeline {
    agent any

    environment {
        // AWS & ECR info
        ACCOUNT_ID       = "070622743298"
        AWS_REGION       = "us-east-1"

        FRONTEND_REPO    = "mern-frontend"
        BACKEND_REPO     = "mern-backend"

        FRONTEND_DOCKERFILE = "MERN-Stack-Ecommerce-App-master/Dockerfile"
        BACKEND_DOCKERFILE  = "MERN-Stack-Ecommerce-App-master/backend/Dockerfile"

        EC2_HOST         = "13.222.179.163"
        EC2_USER         = "jenkins-ecr-user"
        FRONTEND_PORT    = "80"
        BACKEND_PORT     = "3000"

        // Ensure aws CLI is found
        PATH = "/snap/bin:/usr/local/bin:/usr/bin:/bin:${env.PATH}"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Murugan6892/mern-ecommerce-test.git',
                    credentialsId: 'github-pat-token'
            }
        }

        stage('Build Frontend App') {
            steps {
                dir('MERN-Stack-Ecommerce-App-master') {
                    sh """
                    npm install
                    CI=false npm run build
                    """
                }
            }
        }

        stage('Build Frontend Docker Image') {
            steps {
                sh """
                docker build -t ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${FRONTEND_REPO}:latest \
                -f ${FRONTEND_DOCKERFILE} MERN-Stack-Ecommerce-App-master
                """
            }
        }

        stage('Build Backend Docker Image') {
            steps {
                sh """
                docker build -t ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${BACKEND_REPO}:latest \
                -f ${BACKEND_DOCKERFILE} MERN-Stack-Ecommerce-App-master/backend
                """
            }
        }

        stage('Login to AWS ECR') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'jenkins-ecr-user']]) {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} | \
                    docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                }
            }
        }

        stage('Push Images to ECR') {
            steps {
                sh """
                docker push ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${FRONTEND_REPO}:latest
                docker push ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${BACKEND_REPO}:latest
                """
            }
        }

        stage('Deploy on EC2 Slave') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no ${Jenkins}@${EC2_HOST} '
                  aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

                  docker pull ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${FRONTEND_REPO}:latest
                  docker pull ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${BACKEND_REPO}:latest

                  docker rm -f frontend || true
                  docker rm -f backend || true

                  docker run -d --name frontend -p ${FRONTEND_PORT}:80 ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${FRONTEND_REPO}:latest
                  docker run -d --name backend -p ${BACKEND_PORT}:3000 ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${BACKEND_REPO}:latest
                '
                """
            }
        }
    }

    post {
        success {
            echo "✅ MERN app deployed successfully!"
        }
        failure {
            echo "❌ Deployment failed. Check logs."
        }
    }
}
